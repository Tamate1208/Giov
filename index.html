<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>簡易柱状図付きボーリングマップ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            overscroll-behavior-y: none;
        }
        #map { width: 100%; height: 100%; z-index: 0; }
        #main-container { height: calc(100vh - 56px); }

        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* デスクトップ用：横に隠す */
        .sidebar-hidden-desktop { transform: translateX(-100%); width: 0 !important; min-width: 0 !important; margin: 0 !important; border: none !important; }
        
        /* モバイル用：高さをハンドル分（40px）まで縮める（これで地図が広がる） */
        @media (max-width: 767px) {
            #listSidebar { height: 45%; } /* デフォルトの高さ */
            .sidebar-hidden-mobile { height: 40px !important; border-top: 3px solid #3b82f6 !important; }
        }

        .layer-chart-wrapper { margin-bottom: 8px; }
        .layer-chart-container { display: flex; width: 100%; height: 24px; overflow: hidden; border-radius: 4px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .layer-segment { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid rgba(0,0,0,0.3); box-sizing: border-box; transition: width 0.3s; }
        .depth-scale-container { position: relative; width: 100%; height: 14px; margin-top: 2px; font-size: 9px; color: #6b7280; }
        .scale-mark { position: absolute; top: 0; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 1; }
        .scale-line { width: 1px; height: 4px; background-color: #9ca3af; margin-bottom: 0px; }
        .scale-text { line-height: 1; white-space: nowrap; }

        .soil-Sand { background-color: #fcd34d; }
        .soil-Clay { background-color: #8b5cf6; }
        .soil-Gravel { background-color: #9ca3af; }
        .soil-Rock { background-color: #4b5563; }
        .soil-Organic { background-color: #10b981; }

        .n-value-text { color: white; text-shadow: 0 0 2px rgba(0,0,0,0.8), 0 0 4px rgba(0,0,0,0.5); font-size: 11px; font-weight: bold; line-height: 1; white-space: nowrap; }
        .leaflet-tooltip.leaflet-tooltip-top { background-color: #fff; border: 1px solid #d1d5db; padding: 2px 5px; border-radius: 4px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); font-size: 10px; font-weight: 600; opacity: 0.9; white-space: nowrap; }
        .leaflet-tooltip-top:before { border-top-color: transparent !important; }
        .leaflet-popup-content { min-width: 250px !important; margin: 14px !important; }

        .pdf-button { display: block; text-align: center; border: 1px solid #3b82f6; color: #3b82f6; background-color: white; margin-top: 12px; padding: 6px 0; border-radius: 4px; font-size: 12px; transition: all 0.2s; text-decoration: none !important; font-weight: 600; }
        .pdf-button:hover { background-color: #3b82f6; color: white; }
        
        .mobile-handle-bar { width: 40px; height: 4px; background-color: #d1d5db; border-radius: 2px; margin: 0 auto 4px; }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">
    
    <header class="bg-white shadow-sm z-20 px-4 py-2 flex flex-wrap justify-between items-center flex-none">
        <div class="flex items-center space-x-4">
            <div>
                <h1 class="text-base md:text-lg font-bold text-gray-800 leading-tight">ボーリングマップ「GioVision Hiroshima」</h1>
                <p class="hidden md:block text-[10px] text-gray-500">柱状図の下に層境界の深度を表示 ※注：全てダミーデータ</p>
            </div>
            <div class="flex items-center bg-gray-100 rounded-lg px-2 py-1 border border-gray-200">
                <input type="text" id="addressInput" placeholder="住所で検索..." class="bg-transparent text-sm focus:outline-none w-32 md:w-48 px-1">
                <button onclick="searchAddress()" class="bg-blue-500 text-white p-1 rounded hover:bg-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="text-right">
            <span class="text-[10px] text-gray-500">表示範囲内</span>
            <span id="visibleCount" class="text-lg md:text-xl font-bold text-blue-600">0</span>
            <span class="text-[10px] text-gray-500">/ <span id="totalCount">0</span>件</span>
        </div>
    </header>

    <main id="main-container" class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
        
        <div id="listSidebar" class="sidebar-transition w-full md:h-full md:w-1/3 lg:w-1/4 bg-white border-t md:border-t-0 md:border-r border-gray-200 order-2 md:order-1 flex flex-col z-[1001] relative">
            
            <button onclick="toggleSidebar()" class="hidden md:flex absolute -right-6 top-1/2 -translate-y-1/2 bg-white border border-gray-300 rounded-r-md p-1 shadow-md hover:bg-gray-50 z-30">
                <svg id="arrowIconDesktop" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-gray-600 transition-transform">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </button>

            <button onclick="toggleSidebar()" class="md:hidden absolute left-0 right-0 -top-10 bg-white border-t border-l border-r border-gray-300 rounded-t-xl px-6 pt-2 pb-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 flex flex-col items-center">
                <div class="mobile-handle-bar"></div>
                <div class="flex items-center gap-1">
                    <svg id="arrowIconMobile" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-3 h-3 text-gray-500 transition-transform rotate-90">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                    <span id="toggleText" class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Close List</span>
                </div>
            </button>

            <div class="p-3 bg-gray-50 border-b border-gray-200 flex-none overflow-hidden">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">エリア内のデータ一覧</h2>
                <div class="text-xs flex flex-wrap gap-x-3 gap-y-1">
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full soil-Sand mr-1"></div>砂質</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full soil-Clay mr-1"></div>粘性</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full soil-Gravel mr-1"></div>礫混じり</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full soil-Rock mr-1"></div>岩盤</span>
                </div>
            </div>
            <div id="dataList" class="overflow-y-auto p-3 space-y-3 flex-grow bg-white"></div>
        </div>

        <div class="flex-grow w-full md:h-full relative order-1 md:order-2">
            <div id="map"></div>
            <div id="loading" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-full shadow-lg z-[1000] hidden">
                <span class="text-xs font-bold text-gray-600 flex items-center">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    検索中...
                </span>
            </div>
        </div>
    </main>

    <script>
        // --- 住所検索機能 ---
        async function searchAddress() {
            const input = document.getElementById('addressInput').value;
            if (!input) return;
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const result = data[0];
                    map.flyTo([result.lat, result.lon], 15, { duration: 1.5 });
                } else {
                    alert("住所が見つかりませんでした。");
                }
            } catch (error) {
                console.error("検索エラー:", error);
                alert("検索中にエラーが発生しました。");
            } finally {
                loading.classList.add('hidden');
            }
        }

        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAddress();
        });

        // --- 切り替え機能 (レイアウト追従版) ---
        let sidebarVisible = true;
        function toggleSidebar() {
            const sidebar = document.getElementById('listSidebar');
            const toggleText = document.getElementById('toggleText');
            const isMobile = window.innerWidth < 768;
            sidebarVisible = !sidebarVisible;

            if (isMobile) {
                // translateではなくheightを制御することで地図側の領域を変化させる
                sidebar.classList.toggle('sidebar-hidden-mobile', !sidebarVisible);
                document.getElementById('arrowIconMobile').style.transform = sidebarVisible ? 'rotate(90deg)' : 'rotate(-90deg)';
                toggleText.textContent = sidebarVisible ? 'Close List' : 'Open List';
            } else {
                sidebar.classList.toggle('sidebar-hidden-desktop', !sidebarVisible);
                document.getElementById('arrowIconDesktop').style.transform = sidebarVisible ? '' : 'rotate(180deg)';
            }
            
            // レイアウト変化に合わせて地図をリサイズ
            setTimeout(() => { 
                map.invalidateSize({ animate: true }); 
            }, 300);
        }

        // --- データ表示ロジック ---
        let map;
        let markersLayer; 
        let allData = []; 
        let currentPopupId = null;
        let isReRendering = false;

        const soilTypes = ["Sand", "Clay", "Gravel", "Rock", "Organic"];
        const soilNamesJp = { "Sand": "砂質土", "Clay": "粘性土", "Gravel": "礫混じり土", "Rock": "岩盤", "Organic": "腐植土" };
        
        function generateMockData(count) {
            const centerLat = 34.396; const centerLng = 132.459;
            const data = [];
            for (let i = 0; i < count; i++) {
                const lat = centerLat + (Math.random() - 0.5) * 0.4;
                const lng = centerLng + (Math.random() - 0.5) * 0.5;
                const id = `B-${1000 + i}`;
                const totalDepth = Math.floor(Math.random() * 40) + 5; 
                let currentDepth = 0; let layers = []; let layerCount = Math.floor(Math.random() * 4) + 2; 
                for(let j = 0; j < layerCount; j++) {
                    const type = soilTypes[Math.floor(Math.random() * soilTypes.length)];
                    let thickness = (j === layerCount - 1) ? totalDepth - currentDepth : Math.max(1, Math.floor(Math.random() * ((totalDepth - currentDepth) / (layerCount - j)) * 1.5));
                    if (thickness > 0) {
                        let nValue = type === 'Rock' ? 50 + Math.floor(Math.random() * 10) : (type === 'Gravel' || type === 'Sand' ? Math.floor(Math.random() * 50) + 10 : Math.floor(Math.random() * 20) + 1);
                        nValue = Math.min(nValue, 50);
                        layers.push({ type, thickness, startDepth: currentDepth, endDepth: currentDepth + thickness, nValue });
                        currentDepth += thickness;
                    }
                }
                const randomDate = new Date(2023, 0, Math.floor(Math.random() * 365) + 1);
                data.push({ id, lat, lng, depth: currentDepth, layers, date: `${randomDate.getFullYear()}/${(randomDate.getMonth() + 1).toString().padStart(2, '0')}/${randomDate.getDate().toString().padStart(2, '0')}`, description: `総深度 ${currentDepth.toFixed(1)}m / ${soilNamesJp[layers[0].type]}主体` });
            }
            return data;
        }

        function createLayerChartHtml(layers, totalDepth) {
            let chartHtml = ''; let scaleHtml = `<div class="scale-mark" style="left: 0%"><span class="scale-line"></span><span class="scale-text">0</span></div>`;
            layers.forEach(layer => {
                const percentage = (layer.thickness / totalDepth) * 100;
                chartHtml += `<div class="layer-segment soil-${layer.type}" style="width: ${percentage.toFixed(1)}%;" title="${soilNamesJp[layer.type]} N値:${layer.nValue}">${percentage > 5 ? `<span class="n-value-text">${layer.nValue >= 50 ? '50+' : layer.nValue}</span>` : ''}</div>`;
                const depthInt = Math.floor(layer.endDepth); 
                if (depthInt > 0 && depthInt === layer.endDepth) { scaleHtml += `<div class="scale-mark" style="left: ${(layer.endDepth / totalDepth * 100).toFixed(1)}%"><span class="scale-line"></span><span class="scale-text">${depthInt}</span></div>`; }
            });
            return `<div class="layer-chart-wrapper"><div class="layer-chart-container">${chartHtml}</div><div class="depth-scale-container">${scaleHtml}</div></div>`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            allData = generateMockData(300);
            document.getElementById('totalCount').textContent = allData.length;
            initMap();
        });

        function initMap() {
            map = L.map('map', { center: [34.396, 132.459], zoom: 10, zoomControl: false });
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            updateVisibleData();
            map.on('moveend', updateVisibleData);
            map.on('zoomend', updateMarkerTooltipVisibility);
            map.on('popupopen', (e) => { if (e.popup && e.popup._source && e.popup._source.dataId) currentPopupId = e.popup._source.dataId; });
            map.on('popupclose', () => { if (!isReRendering) currentPopupId = null; });
        }

        function renderMarkers(data) {
            isReRendering = true; markersLayer.clearLayers();
            data.forEach(p => {
                const marker = L.marker([p.lat, p.lng]); marker.dataId = p.id;
                marker.bindTooltip(p.id, { direction: 'top', offset: L.point(0, -15) });
                const layerDetails = p.layers.map(l => `<li class="flex justify-between items-center py-0.5 border-b border-gray-100"><span class="text-xs font-medium"><span class="w-2 h-2 inline-block rounded-full soil-${l.type} mr-1"></span>${soilNamesJp[l.type]}</span><span class="text-xs text-gray-500">${l.startDepth.toFixed(1)}m〜${l.endDepth.toFixed(1)}m</span><span class="text-xs font-bold text-gray-800">N=${l.nValue >= 50 ? '50+' : l.nValue}</span></li>`).join('');
                marker.bindPopup(`<div class="min-w-[250px] text-xs"><div class="font-bold text-blue-700 text-sm">${p.id}</div><p class="text-xs text-gray-600 mb-2">採取日: ${p.date} / 総深度: ${p.depth.toFixed(1)}m</p><p class="text-gray-500 mb-2">${p.description}</p>${createLayerChartHtml(p.layers, p.depth)}<div class="mt-2 text-gray-700 font-bold mb-1">層構成詳細</div><ul class="list-none p-0 bg-gray-50 rounded p-2">${layerDetails}</ul><a href="#" class="pdf-button">柱状図PDFを開く (Sample)</a></div>`);
                markersLayer.addLayer(marker);
                if (p.id === currentPopupId) setTimeout(() => marker.openPopup(), 10);
            });
            isReRendering = false; updateMarkerTooltipVisibility();
        }

        function renderList(data) {
            const listContainer = document.getElementById('dataList');
            if (data.length === 0) { listContainer.innerHTML = `<div class="text-center py-10 text-gray-400">範囲内にデータなし</div>`; return; }
            let html = '';
            data.slice(0, 50).forEach(point => {
                html += `<div onclick="focusMarker('${point.id}', ${point.lat}, ${point.lng})" class="cursor-pointer bg-white border border-gray-200 p-3 rounded-lg shadow-sm hover:border-blue-400 transition group">${createLayerChartHtml(point.layers, point.depth)}<div class="flex justify-between items-center mb-1"><span class="font-bold text-sm text-gray-800 group-hover:text-blue-700">${point.id}</span><span class="text-xs text-gray-500">採取日: ${point.date}</span></div><p class="text-xs text-gray-600">総深度: ${point.depth.toFixed(1)}m / ${point.description.split('/')[1].trim()}</p></div>`;
            });
            listContainer.innerHTML = html;
        }

        function updateVisibleData() {
            document.getElementById('loading').classList.remove('hidden');
            setTimeout(() => {
                const bounds = map.getBounds();
                const visibleData = allData.filter(p => bounds.contains(L.latLng(p.lat, p.lng)));
                renderMarkers(visibleData);
                renderList(visibleData);
                document.getElementById('visibleCount').textContent = visibleData.length;
                document.getElementById('loading').classList.add('hidden');
            }, 100);
        }

        window.focusMarker = function(id, lat, lng) {
            if (window.innerWidth < 768 && !sidebarVisible) toggleSidebar(); 
            currentPopupId = id;
            map.flyTo([lat, lng], 15, { duration: 1.0 });
        };

        function updateMarkerTooltipVisibility() {
            const show = map.getZoom() >= 14;
            markersLayer.eachLayer(layer => show ? layer.openTooltip() : layer.closeTooltip());
        }
    </script>
</body>
</html>
